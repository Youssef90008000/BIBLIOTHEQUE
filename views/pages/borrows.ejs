<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestion des Emprunts - Biblioth√®que</title>
    <link rel="stylesheet" href="/css/borrows.css" />
  </head>
  <body>
    <header>
      <h1>Liste des Emprunts</h1>
    </header>
    <div class="search-bar">
      <input
        type="text"
        id="searchInput"
        placeholder="Rechercher un livre ou un emprunteur..."
      />
    </div>
    <div class="container">
      <table>
        <thead>
          <tr>
            <th>Livre</th>
            <th>Emprunteur</th>
            <th>Date d'emprunt</th>
            <th>Date de retour</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="borrowTable">
          <% if (borrows.length === 0) { %>
          <tr>
            <td colspan="6">Aucun emprunt trouv√©.</td>
          </tr>
          <% } else { %> <% borrows.forEach(borrow => { %>
          <tr>
            <td><%= borrow.book.title %></td>
            <td><%= borrow.user.first %> <%= borrow.user.last %></td>
            <td><%= new Date(borrow.date_borrow).toLocaleDateString() %></td>
            <td>
              <%= borrow.date_return ? new
              Date(borrow.date_return).toLocaleDateString() : 'Non d√©fini' %>
            </td>
            <td>
              <% if (borrow.status === 'En cours') { %>
                <span style="color: orange">En cours</span>
              <% } else if (borrow.status === 'Retourn√©') { %>
                <span style="color: green">Retourn√©</span>
              <% } else if (borrow.status === "Valid√©") { %>
                <span style="color: blue">Valid√©</span>
              <% } else if (borrow.status === "non valide") { %>
                <span style="color: red">Non valide</span>
              <% } %>
            </td>
            
            <% if (user && user.role === 'admin') { %>
            <td>
              <div class="actions">
                <a href="/borrow-details/<%= borrow._id %>">D√©tails</a>
                <form
                  action="/borrows/<%= borrow._id %>?_method=DELETE"
                  method="POST"
                  style="display: inline"
                >
                  <button
                    type="submit"
                    class="delete-btn"
                    onclick="return confirm('Voulez-vous vraiment supprimer cet emprunt ?')"
                  >
                    üóë Supprimer
                  </button>
                </form>
              </div>
            </td>
            <% } else { %>
            <td>-</td>
            <% } %>
          </tr>
          <% }) %> <% } %>
        </tbody>
      </table>
    </div>
    <script>
      document
        .getElementById("searchInput")
        .addEventListener("input", function () {
          let filter = this.value.toLowerCase();
          document.querySelectorAll("#borrowTable tr").forEach((row) => {
            let titleCell =
              row.cells.length > 0
                ? row.cells[0].textContent.toLowerCase()
                : "";
            let userCell =
              row.cells.length > 1
                ? row.cells[1].textContent.toLowerCase()
                : "";
            row.style.display =
              titleCell.includes(filter) || userCell.includes(filter)
                ? ""
                : "none";
          });
        });
    </script>
  </body>
</html>
